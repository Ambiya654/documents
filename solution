// ─────────────────────────────────────────────────────────────
// INSERT ACTIVITY
// POST: /ABC/ABCMaster/InsertActivity
// Web Model: ABCActivityInsertModel
// { activityName, activityCode, categoryCode }
// createdBy & createdIPAddress — session se set hota hai
// ─────────────────────────────────────────────────────────────
[HttpPost]
public async Task<IActionResult> InsertActivity([FromBody] ABCActivityInsertModel model)
{
    var responseObj = new ABCActivityInsertResponseModel
    {
        isSucceeded          = false,
        isSessionTimeout     = false,
        returnUrlAfterLogout = "",
        errorMessage         = "",
        data                 = new ABCActivityInsertResponseData()
    };

    if (_workflowSession?.LoggedInUser == null)
    {
        responseObj.returnUrlAfterLogout = Url.Content(CommonConstants.LOGINREDIRECT);
        responseObj.isSessionTimeout     = true;
        return Json(responseObj);
    }

    try
    {
        if (model == null)
        {
            responseObj.errorMessage = "Request body cannot be null";
            return Json(responseObj);
        }

        if (string.IsNullOrWhiteSpace(model.ActivityName))
        {
            responseObj.errorMessage = "Activity name is required";
            return Json(responseObj);
        }

        // Session se set karo
        model.CreatedBy        = _workflowSession.LoggedInUser.EmployeeCode;
        model.CreatedIPAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        _logger.LogInformation($"Calling API InsertActivity: {HelperLayer.Constants.APIConstants.ABCAPIConstants.InsertActivity}");

        var httpClient  = APIHelper.GetHttpClient(_workflowSession.LoggedInUser, _settings.APIUrl);
        var apiResponse = await httpClient.PostAsJsonAsync(
            HelperLayer.Constants.APIConstants.ABCAPIConstants.InsertActivity,
            model
        );

        if (apiResponse.IsSuccessStatusCode)
        {
            var result  = await apiResponse.Content.ReadAsStringAsync();
            var apiData = JsonConvert.DeserializeObject<ABCActivityInsertResponseData>(result);

            if (apiData != null)
            {
                responseObj.isSucceeded  = apiData.Status == 1;
                responseObj.data         = apiData;
                responseObj.errorMessage = apiData.Message;
            }
            else
            {
                responseObj.errorMessage = "Failed to insert activity";
            }
        }
        else
        {
            var errorContent         = await apiResponse.Content.ReadAsStringAsync();
            responseObj.errorMessage = $"API Error: {apiResponse.StatusCode} - {errorContent}";
            _logger.LogError($"InsertActivity API Error: {apiResponse.StatusCode} - {errorContent}");
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "InsertActivity Exception");
        responseObj.errorMessage = ex.Message;
    }

    return Json(responseObj);
}

// ─────────────────────────────────────────────────────────────
// UPDATE ACTIVITY
// POST: /ABC/ABCMaster/UpdateActivity
// Web Model: ABCActivityUpdateModel
// { activityId, activityName, activityCode, categoryCode, subCategoryCode }
// modifiedBy & modifiedIPAddress — session se set hota hai
// ─────────────────────────────────────────────────────────────
[HttpPost]
public async Task<IActionResult> UpdateActivity([FromBody] ABCActivityUpdateModel model)
{
    var responseObj = new ABCActivityUpdateResponseModel
    {
        isSucceeded          = false,
        isSessionTimeout     = false,
        returnUrlAfterLogout = "",
        errorMessage         = "",
        data                 = new ABCActivityInsertResponseData()
    };

    if (_workflowSession?.LoggedInUser == null)
    {
        responseObj.returnUrlAfterLogout = Url.Content(CommonConstants.LOGINREDIRECT);
        responseObj.isSessionTimeout     = true;
        return Json(responseObj);
    }

    try
    {
        if (model == null || model.ActivityId <= 0)
        {
            responseObj.errorMessage = "Valid Activity ID is required";
            return Json(responseObj);
        }

        if (string.IsNullOrWhiteSpace(model.ActivityName))
        {
            responseObj.errorMessage = "Activity name is required";
            return Json(responseObj);
        }

        // Session se set karo
        model.ModifiedBy        = _workflowSession.LoggedInUser.EmployeeCode;
        model.ModifiedIPAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        _logger.LogInformation($"Calling API UpdateActivity for ActivityId: {model.ActivityId}");

        var httpClient  = APIHelper.GetHttpClient(_workflowSession.LoggedInUser, _settings.APIUrl);
        var apiResponse = await httpClient.PostAsJsonAsync(  // ✅ POST — PutAsJsonAsync nahi
            HelperLayer.Constants.APIConstants.ABCAPIConstants.UpdateActivity,
            model
        );

        if (apiResponse.IsSuccessStatusCode)
        {
            var result  = await apiResponse.Content.ReadAsStringAsync();
            var apiData = JsonConvert.DeserializeObject<ABCActivityInsertResponseData>(result);

            if (apiData != null)
            {
                responseObj.isSucceeded  = apiData.Status == 1;
                responseObj.data         = apiData;
                responseObj.errorMessage = apiData.Message;
            }
            else
            {
                responseObj.errorMessage = "Failed to update activity";
            }
        }
        else
        {
            var errorContent         = await apiResponse.Content.ReadAsStringAsync();
            responseObj.errorMessage = $"API Error: {apiResponse.StatusCode} - {errorContent}";
            _logger.LogError($"UpdateActivity API Error: {apiResponse.StatusCode} - {errorContent}");
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "UpdateActivity Exception");
        responseObj.errorMessage = ex.Message;
    }

    return Json(responseObj);
}

// ─────────────────────────────────────────────────────────────
// DELETE ACTIVITY
// POST: /ABC/ABCMaster/DeleteActivity
// Web Model: ABCActivityDeleteModel
// { activityId }
// deletedBy & deletedIPAddress — session se set hota hai
// ─────────────────────────────────────────────────────────────
[HttpPost]
public async Task<IActionResult> DeleteActivity([FromBody] ABCActivityDeleteModel model)
{
    var responseObj = new ABCActivityDeleteResponseModel
    {
        isSucceeded          = false,
        isSessionTimeout     = false,
        returnUrlAfterLogout = "",
        errorMessage         = "",
        data                 = new ABCActivityInsertResponseData()
    };

    if (_workflowSession?.LoggedInUser == null)
    {
        responseObj.returnUrlAfterLogout = Url.Content(CommonConstants.LOGINREDIRECT);
        responseObj.isSessionTimeout     = true;
        return Json(responseObj);
    }

    try
    {
        if (model == null || model.ActivityId <= 0)
        {
            responseObj.errorMessage = "Valid Activity ID is required";
            return Json(responseObj);
        }

        // Session se set karo
        model.DeletedBy        = _workflowSession.LoggedInUser.EmployeeCode;
        model.DeletedIPAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        _logger.LogInformation($"Calling API DeleteActivity for ActivityId: {model.ActivityId}");

        var httpClient  = APIHelper.GetHttpClient(_workflowSession.LoggedInUser, _settings.APIUrl);
        var apiResponse = await httpClient.PostAsJsonAsync(  // ✅ POST — HttpMethod.Delete nahi
            HelperLayer.Constants.APIConstants.ABCAPIConstants.DeleteActivity,
            model
        );

        if (apiResponse.IsSuccessStatusCode)
        {
            var result  = await apiResponse.Content.ReadAsStringAsync();
            var apiData = JsonConvert.DeserializeObject<ABCActivityInsertResponseData>(result);

            if (apiData != null)
            {
                responseObj.isSucceeded  = apiData.Status == 1;
                responseObj.data         = apiData;
                responseObj.errorMessage = apiData.Message;
            }
            else
            {
                responseObj.errorMessage = "Failed to delete activity";
            }
        }
        else
        {
            var errorContent         = await apiResponse.Content.ReadAsStringAsync();
            responseObj.errorMessage = $"API Error: {apiResponse.StatusCode} - {errorContent}";
            _logger.LogError($"DeleteActivity API Error: {apiResponse.StatusCode} - {errorContent}");
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "DeleteActivity Exception");
        responseObj.errorMessage = ex.Message;
    }

    return Json(responseObj);
}





@{
    Layout = "~/Views/Shared/_ABCLayout.cshtml";
}

<div class="content-body">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="@Url.Action("Dashboard", "Home", new { area = "ABC" })">Activity-Based Consolidation</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="@Url.Action("master", "ABCMaster", new { area = "ABC" })">Master</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Add Activity</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="main-body-card masters">
            <div class="card-header justify-content-between">
                <div class="d-flex">
                    <h2 class="main-title">Add Activity</h2>
                </div>
                <div class="d-flex gap-3">
                    <a href="javascript:history.back()" class="btn btn-outline-secondary">Back</a>
                    <button type="button" class="btn btn-success" id="btnSubmitActivity">Submit</button>
                    <button type="button" class="btn btn-outline-secondary d-none" id="btnCancelEdit">Cancel Edit</button>
                </div>
            </div>

            <div class="card-body">
                <div class="main-body-card">

                    <!-- Hidden fields for edit mode -->
                    <input type="hidden" id="hdnEditActivityId"   value="0" />
                    <input type="hidden" id="hdnEditActivityCode" value="" />
                    <input type="hidden" id="hdnEditSubCategoryCode" value="" />
                    <input type="hidden" id="hdnEditMode"         value="false" />

                    <div class="row row-cols-lg-5 gx-3 mb-3">
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label">Company</label>
                                <input type="text" class="form-control" id="txtCompany" readonly />
                            </div>
                        </div>
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label">Department</label>
                                <input type="text" class="form-control" id="txtDepartment" readonly />
                            </div>
                        </div>
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label">Sub Process</label>
                                <input type="text" class="form-control" id="txtSubProcess" readonly />
                            </div>
                        </div>
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" id="txtCategory" readonly />
                                <input type="hidden" id="hdnCategoryCode" />
                            </div>
                        </div>
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label" id="lblActivity">Activity <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="txtActivity"
                                       placeholder="Enter activity name" maxlength="200" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-style-1">
                                    <thead>
                                        <tr>
                                            <th width="60" class="text-center">Sr.No</th>
                                            <th>Company</th>
                                            <th>Department</th>
                                            <th>Subprocess</th>
                                            <th>Category</th>
                                            <th>Activity</th>
                                            <th width="80" class="text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tblActivityData">
                                        <tr>
                                            <td colspan="7" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- SUCCESS MODAL                                          -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="modal fade icon-modal" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                <h5 class="main-text mt-3 mb-2" id="successModalMessage">Operation successful!</h5>
                <button type="button" class="btn btn-success mt-2" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- ERROR MODAL                                            -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="modal fade icon-modal" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <i class="bi bi-x-circle-fill text-danger" style="font-size: 3rem;"></i>
                <h5 class="main-text mt-3 mb-2" id="errorModalMessage">Something went wrong!</h5>
                <button type="button" class="btn btn-danger mt-2" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- DELETE CONFIRMATION MODAL                              -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="modal fade icon-modal" id="deleteActivityModal" data-bs-backdrop="static" data-bs-keyboard="false"
     tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
                        data-bs-dismiss="modal" aria-label="Close"></button>
                <input type="hidden" id="deleteActivityId" />
                <i class="bi bi-trash3 text-danger" style="font-size: 3rem;"></i>
                <h5 class="main-text mb-2 mt-3">Are you sure you want to delete?</h5>
                <h6 class="mb-2 fw-bold" id="deleteActivityNameDisplay"></h6>
                <p class="text-muted small mb-4">All associated data will be lost.</p>
                <button type="button" class="btn btn-danger" id="btnConfirmDeleteActivity">Yes, Delete</button>
                <button type="button" class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/areas/ABC/assets/js/custom/addactivity.js"></script>
}


$(document).ready(function () {
    initializeAddActivityPage();
    bindAddActivityEvents();
});

var selectedCategoryCode   = '';
var selectedCategoryName   = '';
var selectedCompanyCode    = '';
var selectedCompanyName    = '';
var selectedDepartmentCode = '';
var selectedDepartmentName = '';
var selectedSubProcessCode = '';
var selectedSubProcessName = '';

// ─────────────────────────────────────────────────────────────
function bindAddActivityEvents() {
    $('#btnSubmitActivity').on('click', onSubmitActivityClick);
    $('#btnCancelEdit').on('click',     onCancelEditClick);

    $(document).on('click', '.edit-activity-btn',        onEditActivityClick);
    $(document).on('click', '.delete-activity-btn',      onDeleteActivityClick);
    $(document).on('click', '#btnConfirmDeleteActivity', onConfirmDeleteClick);
}

// ─────────────────────────────────────────────────────────────
function initializeAddActivityPage() {
    const urlParams = new URLSearchParams(window.location.search);

    const categoryCode   = urlParams.get('categoryCode')   || '';
    const categoryName   = urlParams.get('categoryName')   || '';
    const companyCode    = urlParams.get('companyCode')    || '';
    const companyName    = urlParams.get('companyName')    || '';
    const departmentCode = urlParams.get('departmentCode') || '';
    const departmentName = urlParams.get('departmentName') || '';
    const subprocessCode = urlParams.get('subprocessCode') || '';
    const subprocessName = urlParams.get('subprocessName') || '';

    if (!categoryCode) {
        showError('Missing required parameters. Please select a category from the list.');
        setTimeout(function () { window.history.back(); }, 2000);
        return;
    }

    $('#txtCompany').val(companyName);
    $('#txtDepartment').val(departmentName);
    $('#txtSubProcess').val(subprocessName);
    $('#txtCategory').val(categoryName);
    $('#hdnCategoryCode').val(categoryCode);

    selectedCategoryCode   = categoryCode;
    selectedCategoryName   = categoryName;
    selectedCompanyCode    = companyCode;
    selectedCompanyName    = companyName;
    selectedDepartmentCode = departmentCode;
    selectedDepartmentName = departmentName;
    selectedSubProcessCode = subprocessCode;
    selectedSubProcessName = subprocessName;

    loadActivityList();
}

// ─────────────────────────────────────────────────────────────
// SUCCESS MODAL
// ─────────────────────────────────────────────────────────────
function showSuccess(message) {
    $('#successModalMessage').text(message);
    new bootstrap.Modal(document.getElementById('successModal')).show();
}

// ─────────────────────────────────────────────────────────────
// ERROR MODAL
// ─────────────────────────────────────────────────────────────
function showError(message) {
    $('#errorModalMessage').text(message);
    new bootstrap.Modal(document.getElementById('errorModal')).show();
}

// ─────────────────────────────────────────────────────────────
// Enter EDIT mode — same top txtActivity textbox use karo
// ─────────────────────────────────────────────────────────────
function enterEditMode(activityId, activityName, activityCode, subCategoryCode) {
    $('#hdnEditActivityId').val(activityId);
    $('#hdnEditActivityCode').val(activityCode);
    $('#hdnEditSubCategoryCode').val(subCategoryCode || '');
    $('#hdnEditMode').val('true');

    $('#txtActivity').val(activityName).focus().select();
    $('#lblActivity').html('Edit Activity <span class="text-danger">*</span>');
    $('#btnSubmitActivity').text('Update');
    $('#btnCancelEdit').removeClass('d-none');

    $('html, body').animate({ scrollTop: $('#txtActivity').offset().top - 100 }, 300);
}

// ─────────────────────────────────────────────────────────────
// Enter INSERT mode — form reset
// ─────────────────────────────────────────────────────────────
function enterInsertMode() {
    $('#hdnEditActivityId').val('0');
    $('#hdnEditActivityCode').val('');
    $('#hdnEditSubCategoryCode').val('');
    $('#hdnEditMode').val('false');

    $('#txtActivity').val('');
    $('#lblActivity').html('Activity <span class="text-danger">*</span>');
    $('#btnSubmitActivity').text('Submit').prop('disabled', false);
    $('#btnCancelEdit').addClass('d-none');
}

// ─────────────────────────────────────────────────────────────
// LOAD ACTIVITY LIST
// GET: /ABC/ABCMaster/GetActivityList
// Params: categoryCode, subCategoryCode
// ─────────────────────────────────────────────────────────────
function loadActivityList() {
    if (!selectedCategoryCode) {
        $('#tblActivityData').html('<tr><td colspan="7" class="text-center">No category selected</td></tr>');
        return;
    }

    $('#tblActivityData').html('<tr><td colspan="7" class="text-center">Loading...</td></tr>');

    $.ajax({
        url: '/ABC/ABCMaster/GetActivityList',
        type: 'GET',
        data: {
            categoryCode:    selectedCategoryCode,
            subCategoryCode: null
        },
        dataType: 'json',
        success: function (response) {
            if (response && response.isSessionTimeout) {
                window.location.href = response.returnUrlAfterLogout;
                return;
            }
            if (response && response.isSucceeded && response.data && response.data.activityList) {
                populateActivityTable(response.data.activityList);
            } else {
                $('#tblActivityData').html('<tr><td colspan="7" class="text-center">No activities found</td></tr>');
            }
        },
        error: function () {
            $('#tblActivityData').html('<tr><td colspan="7" class="text-center text-danger">Error loading activities</td></tr>');
        }
    });
}

// ─────────────────────────────────────────────────────────────
// POPULATE TABLE
// Dropdown: Edit | Delete
// ─────────────────────────────────────────────────────────────
function populateActivityTable(activities) {
    const $tbody = $('#tblActivityData');
    $tbody.empty();

    if (!activities || activities.length === 0) {
        $tbody.html('<tr><td colspan="7" class="text-center">No activities found</td></tr>');
        return;
    }

    $.each(activities, function (index, activity) {
        const rowHtml = `
            <tr id="row-activity-${activity.activityId}">
                <td class="text-center">${index + 1}</td>
                <td>${escapeHtml(activity.company_Name    || '')}</td>
                <td>${escapeHtml(activity.department_Name || '')}</td>
                <td>${escapeHtml(activity.subProcess_Name || '')}</td>
                <td>${escapeHtml(activity.categoryName    || '')}</td>
                <td>${escapeHtml(activity.activityName    || '')}</td>
                <td class="text-center action-col">
                    <a href="javascript:;" class="dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots"></i>
                    </a>
                    <ul class="dropdown-menu mt-2">
                        <li>
                            <a href="javascript:;" class="dropdown-item edit-activity-btn"
                               data-id="${activity.activityId}"
                               data-name="${escapeHtml(activity.activityName || '')}"
                               data-code="${escapeHtml(activity.activityCode || '')}"
                               data-subcategory="${escapeHtml(activity.subCategoryCode || '')}">
                                <i class="bi bi-pencil me-2"></i>Edit
                            </a>
                        </li>
                        <li>
                            <a href="javascript:;" class="dropdown-item text-danger delete-activity-btn"
                               data-id="${activity.activityId}"
                               data-name="${escapeHtml(activity.activityName || '')}">
                                <i class="bi bi-trash3 me-2"></i>Delete
                            </a>
                        </li>
                    </ul>
                </td>
            </tr>
        `;
        $tbody.append(rowHtml);
    });
}

// ─────────────────────────────────────────────────────────────
// SUBMIT — Insert ya Update decide karta hai hdnEditMode se
// ─────────────────────────────────────────────────────────────
function onSubmitActivityClick() {
    if ($('#hdnEditMode').val() === 'true') {
        doUpdateActivity();
    } else {
        doInsertActivity();
    }
}

function onCancelEditClick() {
    enterInsertMode();
}

// ─────────────────────────────────────────────────────────────
// INSERT ACTIVITY
// POST: /ABC/ABCMaster/InsertActivity
// Web Model: ABCActivityInsertModel
// { activityName, activityCode, categoryCode }
// createdBy & createdIPAddress — Web Controller session se set karta hai
// ─────────────────────────────────────────────────────────────
function doInsertActivity() {
    const activityName = $('#txtActivity').val().trim();

    if (!activityName) {
        showError('Please enter activity name');
        $('#txtActivity').focus();
        return;
    }

    if (!selectedCategoryCode) {
        showError('Missing category information. Please go back and select again.');
        return;
    }

    const insertData = {
        activityName: activityName,
        activityCode: null,               // SP auto-generate karta hai
        categoryCode: selectedCategoryCode
        // createdBy & createdIPAddress: Web Controller session se set karega
    };

    $('#btnSubmitActivity').prop('disabled', true).text('Saving...');

    $.ajax({
        url: '/ABC/ABCMaster/InsertActivity',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(insertData),
        dataType: 'json',
        success: function (response) {
            if (response && response.isSessionTimeout) {
                window.location.href = response.returnUrlAfterLogout;
                return;
            }
            if (response && response.isSucceeded) {
                showSuccess('Activity added successfully!');
                $('#txtActivity').val('');
                loadActivityList();
            } else {
                showError(response.errorMessage || 'Failed to add activity');
            }
        },
        error: function (xhr) {
            try {
                const err = JSON.parse(xhr.responseText);
                showError(err.error || err.message || 'Error occurred');
            } catch (e) {
                showError('Error adding activity');
            }
        },
        complete: function () {
            $('#btnSubmitActivity').prop('disabled', false).text('Submit');
        }
    });
}

// ─────────────────────────────────────────────────────────────
// UPDATE ACTIVITY
// POST: /ABC/ABCMaster/UpdateActivity
// Web Model: ABCActivityUpdateModel
// { activityId, activityName, activityCode, categoryCode, subCategoryCode }
// modifiedBy & modifiedIPAddress — Web Controller session se set karta hai
// ─────────────────────────────────────────────────────────────
function doUpdateActivity() {
    const activityId      = parseInt($('#hdnEditActivityId').val());
    const activityName    = $('#txtActivity').val().trim();
    const activityCode    = $('#hdnEditActivityCode').val()    || '';
    const subCategoryCode = $('#hdnEditSubCategoryCode').val() || '';

    if (!activityName) {
        showError('Activity name cannot be empty');
        $('#txtActivity').focus();
        return;
    }

    if (!activityId || activityId <= 0) {
        showError('Invalid Activity ID');
        return;
    }

    const updateData = {
        activityId:      activityId,
        activityName:    activityName,
        activityCode:    activityCode,
        categoryCode:    selectedCategoryCode,
        subCategoryCode: subCategoryCode
        // modifiedBy & modifiedIPAddress: Web Controller session se set karega
    };

    $('#btnSubmitActivity').prop('disabled', true).text('Updating...');

    $.ajax({
        url: '/ABC/ABCMaster/UpdateActivity',
        type: 'POST',   // ✅ POST — API [HttpPost] expect karta hai
        contentType: 'application/json',
        data: JSON.stringify(updateData),
        dataType: 'json',
        success: function (response) {
            if (response && response.isSessionTimeout) {
                window.location.href = response.returnUrlAfterLogout;
                return;
            }
            if (response && response.isSucceeded) {
                showSuccess('Activity updated successfully!');
                enterInsertMode();
                loadActivityList();
            } else {
                showError(response.errorMessage || 'Failed to update activity');
                $('#btnSubmitActivity').prop('disabled', false).text('Update');
            }
        },
        error: function (xhr) {
            try {
                const err = JSON.parse(xhr.responseText);
                showError(err.error || err.errorMessage || 'Error occurred');
            } catch (e) {
                showError('Error updating activity');
            }
            $('#btnSubmitActivity').prop('disabled', false).text('Update');
        }
    });
}

// ─────────────────────────────────────────────────────────────
// EDIT button click — same top txtActivity textbox mein naam daalo
// ─────────────────────────────────────────────────────────────
function onEditActivityClick() {
    const activityId      = $(this).data('id');
    const activityName    = $(this).data('name');
    const activityCode    = $(this).data('code');
    const subCategoryCode = $(this).data('subcategory');
    enterEditMode(activityId, activityName, activityCode, subCategoryCode);
}

// ─────────────────────────────────────────────────────────────
// DELETE — confirmation modal open karo
// ─────────────────────────────────────────────────────────────
function onDeleteActivityClick() {
    const activityId   = $(this).data('id');
    const activityName = $(this).data('name');

    $('#deleteActivityId').val(activityId);
    $('#deleteActivityNameDisplay').text(activityName);
    new bootstrap.Modal(document.getElementById('deleteActivityModal')).show();
}

// ─────────────────────────────────────────────────────────────
// CONFIRM DELETE
// POST: /ABC/ABCMaster/DeleteActivity
// Web Model: ABCActivityDeleteModel
// { activityId }
// deletedBy & deletedIPAddress — Web Controller session se set karta hai
// ─────────────────────────────────────────────────────────────
function onConfirmDeleteClick() {
    const activityId = parseInt($('#deleteActivityId').val());

    if (!activityId || activityId <= 0) {
        showError('Invalid Activity ID');
        return;
    }

    const deleteData = {
        activityId: activityId
        // deletedBy & deletedIPAddress: Web Controller session se set karega
    };

    $('#btnConfirmDeleteActivity').prop('disabled', true).text('Deleting...');

    $.ajax({
        url: '/ABC/ABCMaster/DeleteActivity',
        type: 'POST',   // ✅ POST — API [HttpPost] expect karta hai
        contentType: 'application/json',
        data: JSON.stringify(deleteData),
        dataType: 'json',
        success: function (response) {
            bootstrap.Modal.getInstance(document.getElementById('deleteActivityModal')).hide();

            if (response && response.isSessionTimeout) {
                window.location.href = response.returnUrlAfterLogout;
                return;
            }
            if (response && response.isSucceeded) {
                // Agar deleted activity ka edit chal raha tha toh reset karo
                if ($('#hdnEditMode').val() === 'true' &&
                    parseInt($('#hdnEditActivityId').val()) === activityId) {
                    enterInsertMode();
                }
                showSuccess('Activity deleted successfully!');
                loadActivityList();
            } else {
                showError(response.errorMessage || 'Failed to delete activity');
            }
        },
        error: function (xhr) {
            bootstrap.Modal.getInstance(document.getElementById('deleteActivityModal')).hide();
            try {
                const err = JSON.parse(xhr.responseText);
                showError(err.error || err.errorMessage || 'Error occurred');
            } catch (e) {
                showError('Error deleting activity');
            }
        },
        complete: function () {
            $('#btnConfirmDeleteActivity').prop('disabled', false).text('Yes, Delete');
        }
    });
}

// ─────────────────────────────────────────────────────────────
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
