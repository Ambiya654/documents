// ─────────────────────────────────────────────────────────────
// INSERT SUBCATEGORY
// POST: /ABC/ABCMaster/InsertSubCategory
// Web Model: ABCSubCategoryInsertModel
// { subCategoryName, subCategoryCode, categoryCode }
// createdBy & createdIPAddress — session se set hota hai
// ─────────────────────────────────────────────────────────────
[HttpPost]
public async Task<IActionResult> InsertSubCategory([FromBody] ABCSubCategoryInsertModel model)
{
    var responseObj = new ABCSubCategoryInsertResponseModel
    {
        isSucceeded          = false,
        isSessionTimeout     = false,
        returnUrlAfterLogout = "",
        errorMessage         = "",
        data                 = new ABCSubCategoryInsertResponseData()
    };

    if (_workflowSession?.LoggedInUser == null)
    {
        responseObj.returnUrlAfterLogout = Url.Content(CommonConstants.LOGINREDIRECT);
        responseObj.isSessionTimeout     = true;
        return Json(responseObj);
    }

    try
    {
        if (model == null)
        {
            responseObj.errorMessage = "Request body cannot be null";
            return Json(responseObj);
        }

        if (string.IsNullOrWhiteSpace(model.SubCategoryName))
        {
            responseObj.errorMessage = "SubCategory name is required";
            return Json(responseObj);
        }

        if (string.IsNullOrWhiteSpace(model.CategoryCode))
        {
            responseObj.errorMessage = "Category code is required";
            return Json(responseObj);
        }

        // Session se set karo
        model.CreatedBy        = _workflowSession.LoggedInUser.EmployeeCode;
        model.CreatedIPAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        _logger.LogInformation($"Calling API InsertSubCategory: {HelperLayer.Constants.APIConstants.ABCAPIConstants.InsertSubCategory}");

        var httpClient  = APIHelper.GetHttpClient(_workflowSession.LoggedInUser, _settings.APIUrl);
        var apiResponse = await httpClient.PostAsJsonAsync(
            HelperLayer.Constants.APIConstants.ABCAPIConstants.InsertSubCategory,
            model
        );

        if (apiResponse.IsSuccessStatusCode)
        {
            var result  = await apiResponse.Content.ReadAsStringAsync();
            var apiData = JsonConvert.DeserializeObject<ABCSubCategoryInsertResponseData>(result);

            if (apiData != null)
            {
                responseObj.isSucceeded  = apiData.Status == 1;
                responseObj.data         = apiData;
                responseObj.errorMessage = apiData.Message;
            }
            else
            {
                responseObj.errorMessage = "Failed to insert subcategory";
            }
        }
        else
        {
            var errorContent         = await apiResponse.Content.ReadAsStringAsync();
            responseObj.errorMessage = $"API Error: {apiResponse.StatusCode} - {errorContent}";
            _logger.LogError($"InsertSubCategory API Error: {apiResponse.StatusCode} - {errorContent}");
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "InsertSubCategory Exception");
        responseObj.errorMessage = ex.Message;
    }

    return Json(responseObj);
}

// ─────────────────────────────────────────────────────────────
// UPDATE SUBCATEGORY
// POST: /ABC/ABCMaster/UpdateSubCategory
// Web Model: ABCSubCategoryUpdateModel
// { subCategoryId, subCategoryName, subCategoryCode, categoryCode }
// modifiedBy & modifiedIPAddress — session se set hota hai
// ─────────────────────────────────────────────────────────────
[HttpPost]
public async Task<IActionResult> UpdateSubCategory([FromBody] ABCSubCategoryUpdateModel model)
{
    var responseObj = new ABCSubCategoryUpdateResponseModel
    {
        isSucceeded          = false,
        isSessionTimeout     = false,
        returnUrlAfterLogout = "",
        errorMessage         = "",
        data                 = new ABCSubCategoryInsertResponseData()
    };

    if (_workflowSession?.LoggedInUser == null)
    {
        responseObj.returnUrlAfterLogout = Url.Content(CommonConstants.LOGINREDIRECT);
        responseObj.isSessionTimeout     = true;
        return Json(responseObj);
    }

    try
    {
        if (model == null || model.SubCategoryId <= 0)
        {
            responseObj.errorMessage = "Valid SubCategory ID is required";
            return Json(responseObj);
        }

        if (string.IsNullOrWhiteSpace(model.SubCategoryName))
        {
            responseObj.errorMessage = "SubCategory name is required";
            return Json(responseObj);
        }

        // Session se set karo
        model.ModifiedBy        = _workflowSession.LoggedInUser.EmployeeCode;
        model.ModifiedIPAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        _logger.LogInformation($"Calling API UpdateSubCategory for SubCategoryId: {model.SubCategoryId}");

        var httpClient  = APIHelper.GetHttpClient(_workflowSession.LoggedInUser, _settings.APIUrl);
        var apiResponse = await httpClient.PostAsJsonAsync(  // ✅ POST — PutAsJsonAsync nahi
            HelperLayer.Constants.APIConstants.ABCAPIConstants.UpdateSubCategory,
            model
        );

        if (apiResponse.IsSuccessStatusCode)
        {
            var result  = await apiResponse.Content.ReadAsStringAsync();
            var apiData = JsonConvert.DeserializeObject<ABCSubCategoryInsertResponseData>(result);

            if (apiData != null)
            {
                responseObj.isSucceeded  = apiData.Status == 1;
                responseObj.data         = apiData;
                responseObj.errorMessage = apiData.Message;
            }
            else
            {
                responseObj.errorMessage = "Failed to update subcategory";
            }
        }
        else
        {
            var errorContent         = await apiResponse.Content.ReadAsStringAsync();
            responseObj.errorMessage = $"API Error: {apiResponse.StatusCode} - {errorContent}";
            _logger.LogError($"UpdateSubCategory API Error: {apiResponse.StatusCode} - {errorContent}");
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "UpdateSubCategory Exception");
        responseObj.errorMessage = ex.Message;
    }

    return Json(responseObj);
}

// ─────────────────────────────────────────────────────────────
// DELETE SUBCATEGORY
// POST: /ABC/ABCMaster/DeleteSubCategory
// Web Model: ABCSubCategoryDeleteModel
// { subCategoryId }
// deletedBy & deletedIPAddress — session se set hota hai
// ─────────────────────────────────────────────────────────────
[HttpPost]
public async Task<IActionResult> DeleteSubCategory([FromBody] ABCSubCategoryDeleteModel model)
{
    var responseObj = new ABCSubCategoryDeleteResponseModel
    {
        isSucceeded          = false,
        isSessionTimeout     = false,
        returnUrlAfterLogout = "",
        errorMessage         = "",
        data                 = new ABCSubCategoryInsertResponseData()
    };

    if (_workflowSession?.LoggedInUser == null)
    {
        responseObj.returnUrlAfterLogout = Url.Content(CommonConstants.LOGINREDIRECT);
        responseObj.isSessionTimeout     = true;
        return Json(responseObj);
    }

    try
    {
        if (model == null || model.SubCategoryId <= 0)
        {
            responseObj.errorMessage = "Valid SubCategory ID is required";
            return Json(responseObj);
        }

        // Session se set karo
        model.DeletedBy        = _workflowSession.LoggedInUser.EmployeeCode;
        model.DeletedIPAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        _logger.LogInformation($"Calling API DeleteSubCategory for SubCategoryId: {model.SubCategoryId}");

        var httpClient  = APIHelper.GetHttpClient(_workflowSession.LoggedInUser, _settings.APIUrl);
        var apiResponse = await httpClient.PostAsJsonAsync(  // ✅ POST — HttpMethod.Delete nahi
            HelperLayer.Constants.APIConstants.ABCAPIConstants.DeleteSubCategory,
            model
        );

        if (apiResponse.IsSuccessStatusCode)
        {
            var result  = await apiResponse.Content.ReadAsStringAsync();
            var apiData = JsonConvert.DeserializeObject<ABCSubCategoryInsertResponseData>(result);

            if (apiData != null)
            {
                responseObj.isSucceeded  = apiData.Status == 1;
                responseObj.data         = apiData;
                responseObj.errorMessage = apiData.Message;
            }
            else
            {
                responseObj.errorMessage = "Failed to delete subcategory";
            }
        }
        else
        {
            var errorContent         = await apiResponse.Content.ReadAsStringAsync();
            responseObj.errorMessage = $"API Error: {apiResponse.StatusCode} - {errorContent}";
            _logger.LogError($"DeleteSubCategory API Error: {apiResponse.StatusCode} - {errorContent}");
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "DeleteSubCategory Exception");
        responseObj.errorMessage = ex.Message;
    }

    return Json(responseObj);
}





@{
    Layout = "~/Views/Shared/_ABCLayout.cshtml";
}

<div class="content-body">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="@Url.Action("Dashboard", "Home", new { area = "ABC" })">Activity-Based Consolidation</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="@Url.Action("master", "ABCMaster", new { area = "ABC" })">Master</a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Add SubCategory</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="main-body-card masters">
            <div class="card-header justify-content-between">
                <div class="d-flex">
                    <h2 class="main-title">Add SubCategory</h2>
                </div>
                <div class="d-flex gap-3">
                    <a href="javascript:history.back()" class="btn btn-outline-secondary">Back</a>
                    <button type="button" class="btn btn-success" id="btnSubmitSubCategory">Submit</button>
                    <button type="button" class="btn btn-outline-secondary d-none" id="btnCancelEdit">Cancel Edit</button>
                </div>
            </div>

            <div class="card-body">
                <div class="main-body-card">

                    <!-- Hidden fields for edit mode -->
                    <input type="hidden" id="hdnEditSubCategoryId"   value="0" />
                    <input type="hidden" id="hdnEditSubCategoryCode" value="" />
                    <input type="hidden" id="hdnEditMode"            value="false" />

                    <div class="row row-cols-lg-5 mb-3">
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label">Company</label>
                                <input type="text" class="form-control" id="txtCompany" readonly />
                            </div>
                        </div>
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label">Department</label>
                                <input type="text" class="form-control" id="txtDepartment" readonly />
                            </div>
                        </div>
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label">Sub Process</label>
                                <input type="text" class="form-control" id="txtSubProcess" readonly />
                            </div>
                        </div>
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" id="txtCategory" readonly />
                                <input type="hidden" id="hdnCategoryCode" />
                            </div>
                        </div>
                        <div class="col-md-6 col-lg">
                            <div class="mb-3">
                                <label class="form-label" id="lblSubCategory">SubCategory <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="txtSubCategory"
                                       placeholder="Enter subcategory name" maxlength="200" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-style-1">
                                    <thead>
                                        <tr>
                                            <th width="60" class="text-center">Sr.No</th>
                                            <th>Company</th>
                                            <th>Department</th>
                                            <th>Subprocess</th>
                                            <th>Category</th>
                                            <th>SubCategory</th>
                                            <th width="100" class="text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tblSubCategoryData">
                                        <tr>
                                            <td colspan="7" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- SUCCESS MODAL                                          -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="modal fade icon-modal" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                <h5 class="main-text mt-3 mb-2" id="successModalMessage">Operation successful!</h5>
                <button type="button" class="btn btn-success mt-2" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- ERROR MODAL                                            -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="modal fade icon-modal" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <i class="bi bi-x-circle-fill text-danger" style="font-size: 3rem;"></i>
                <h5 class="main-text mt-3 mb-2" id="errorModalMessage">Something went wrong!</h5>
                <button type="button" class="btn btn-danger mt-2" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════ -->
<!-- DELETE CONFIRMATION MODAL                              -->
<!-- ═══════════════════════════════════════════════════════ -->
<div class="modal fade icon-modal" id="deleteSubCategoryModal" data-bs-backdrop="static" data-bs-keyboard="false"
     tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3"
                        data-bs-dismiss="modal" aria-label="Close"></button>
                <input type="hidden" id="deleteSubCategoryId" />
                <i class="bi bi-trash3 text-danger" style="font-size: 3rem;"></i>
                <h5 class="main-text mb-2 mt-3">Are you sure you want to delete?</h5>
                <h6 class="mb-2 fw-bold" id="deleteSubCategoryNameDisplay"></h6>
                <p class="text-muted small mb-4">All associated data will be lost.</p>
                <button type="button" class="btn btn-danger" id="btnConfirmDeleteSubCategory">Yes, Delete</button>
                <button type="button" class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/areas/ABC/assets/js/custom/addsubcategory.js"></script>
}




$(document).ready(function () {
    initializeAddSubCategoryPage();
    bindAddSubCategoryEvents();
});

var selectedCategoryCode    = '';
var selectedCategoryName    = '';
var selectedCompanyCode     = '';
var selectedCompanyName     = '';
var selectedDepartmentCode  = '';
var selectedDepartmentName  = '';
var selectedSubProcessCode  = '';
var selectedSubProcessName  = '';

// ─────────────────────────────────────────────────────────────
function bindAddSubCategoryEvents() {
    $('#btnSubmitSubCategory').on('click', onSubmitSubCategoryClick);
    $('#btnCancelEdit').on('click',        onCancelEditClick);

    $(document).on('click', '.edit-subcategory-btn',        onEditSubCategoryClick);
    $(document).on('click', '.delete-subcategory-btn',      onDeleteSubCategoryClick);
    $(document).on('click', '#btnConfirmDeleteSubCategory', onConfirmDeleteClick);
}

// ─────────────────────────────────────────────────────────────
function initializeAddSubCategoryPage() {
    const urlParams = new URLSearchParams(window.location.search);

    const categoryCode   = urlParams.get('categoryCode')   || '';
    const categoryName   = urlParams.get('categoryName')   || '';
    const companyCode    = urlParams.get('companyCode')    || '';
    const companyName    = urlParams.get('companyName')    || '';
    const departmentCode = urlParams.get('departmentCode') || '';
    const departmentName = urlParams.get('departmentName') || '';
    const subprocessCode = urlParams.get('subprocessCode') || '';
    const subprocessName = urlParams.get('subprocessName') || '';

    if (!categoryCode) {
        showError('Missing required parameters. Please select a category from the list.');
        setTimeout(function () { window.history.back(); }, 2000);
        return;
    }

    $('#txtCompany').val(companyName);
    $('#txtDepartment').val(departmentName);
    $('#txtSubProcess').val(subprocessName);
    $('#txtCategory').val(categoryName);
    $('#hdnCategoryCode').val(categoryCode);

    selectedCategoryCode   = categoryCode;
    selectedCategoryName   = categoryName;
    selectedCompanyCode    = companyCode;
    selectedCompanyName    = companyName;
    selectedDepartmentCode = departmentCode;
    selectedDepartmentName = departmentName;
    selectedSubProcessCode = subprocessCode;
    selectedSubProcessName = subprocessName;

    loadSubCategoryList();
}

// ─────────────────────────────────────────────────────────────
// SUCCESS MODAL
// ─────────────────────────────────────────────────────────────
function showSuccess(message) {
    $('#successModalMessage').text(message);
    new bootstrap.Modal(document.getElementById('successModal')).show();
}

// ─────────────────────────────────────────────────────────────
// ERROR MODAL
// ─────────────────────────────────────────────────────────────
function showError(message) {
    $('#errorModalMessage').text(message);
    new bootstrap.Modal(document.getElementById('errorModal')).show();
}

// ─────────────────────────────────────────────────────────────
// Enter EDIT mode — same top txtSubCategory textbox use karo
// ─────────────────────────────────────────────────────────────
function enterEditMode(subCategoryId, subCategoryName, subCategoryCode) {
    $('#hdnEditSubCategoryId').val(subCategoryId);
    $('#hdnEditSubCategoryCode').val(subCategoryCode);
    $('#hdnEditMode').val('true');

    $('#txtSubCategory').val(subCategoryName).focus().select();
    $('#lblSubCategory').html('Edit SubCategory <span class="text-danger">*</span>');
    $('#btnSubmitSubCategory').text('Update');
    $('#btnCancelEdit').removeClass('d-none');

    $('html, body').animate({ scrollTop: $('#txtSubCategory').offset().top - 100 }, 300);
}

// ─────────────────────────────────────────────────────────────
// Enter INSERT mode — form reset
// ─────────────────────────────────────────────────────────────
function enterInsertMode() {
    $('#hdnEditSubCategoryId').val('0');
    $('#hdnEditSubCategoryCode').val('');
    $('#hdnEditMode').val('false');

    $('#txtSubCategory').val('');
    $('#lblSubCategory').html('SubCategory <span class="text-danger">*</span>');
    $('#btnSubmitSubCategory').text('Submit').prop('disabled', false);
    $('#btnCancelEdit').addClass('d-none');
}

// ─────────────────────────────────────────────────────────────
// LOAD SUBCATEGORY LIST
// GET: /ABC/ABCMaster/GetSubCategoryList
// Params: categoryCode
// ─────────────────────────────────────────────────────────────
function loadSubCategoryList() {
    if (!selectedCategoryCode) {
        $('#tblSubCategoryData').html('<tr><td colspan="7" class="text-center">No category selected</td></tr>');
        return;
    }

    $('#tblSubCategoryData').html('<tr><td colspan="7" class="text-center">Loading...</td></tr>');

    $.ajax({
        url: '/ABC/ABCMaster/GetSubCategoryList',
        type: 'GET',
        data: { categoryCode: selectedCategoryCode },
        dataType: 'json',
        success: function (response) {
            if (response && response.isSessionTimeout) {
                window.location.href = response.returnUrlAfterLogout;
                return;
            }
            if (response && response.isSucceeded && response.data && response.data.subCategoryList) {
                populateSubCategoryTable(response.data.subCategoryList);
            } else {
                $('#tblSubCategoryData').html('<tr><td colspan="7" class="text-center">No subcategories found</td></tr>');
            }
        },
        error: function () {
            $('#tblSubCategoryData').html('<tr><td colspan="7" class="text-center text-danger">Error loading subcategories</td></tr>');
        }
    });
}

// ─────────────────────────────────────────────────────────────
// POPULATE TABLE
// Action col: Edit icon | Delete icon (same as category page style)
// ─────────────────────────────────────────────────────────────
function populateSubCategoryTable(subCategories) {
    const $tbody = $('#tblSubCategoryData');
    $tbody.empty();

    if (!subCategories || subCategories.length === 0) {
        $tbody.html('<tr><td colspan="7" class="text-center">No subcategories found for this category</td></tr>');
        return;
    }

    $.each(subCategories, function (index, sc) {
        const rowHtml = `
            <tr id="row-subcategory-${sc.subCategoryId}">
                <td class="text-center">${index + 1}</td>
                <td>${escapeHtml(sc.company_Name    || '')}</td>
                <td>${escapeHtml(sc.department_Name || '')}</td>
                <td>${escapeHtml(sc.subProcess_Name || '')}</td>
                <td>${escapeHtml(sc.categoryName    || '')}</td>
                <td>${escapeHtml(sc.subCategoryName || '')}</td>
                <td class="text-center action-col">
                    <a href="javascript:;" class="dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots"></i>
                    </a>
                    <ul class="dropdown-menu mt-2">
                        <li>
                            <a href="javascript:;" class="dropdown-item edit-subcategory-btn"
                               data-id="${sc.subCategoryId}"
                               data-name="${escapeHtml(sc.subCategoryName || '')}"
                               data-code="${escapeHtml(sc.subCategoryCode || '')}">
                                <i class="bi bi-pencil me-2"></i>Edit
                            </a>
                        </li>
                        <li>
                            <a href="javascript:;" class="dropdown-item text-danger delete-subcategory-btn"
                               data-id="${sc.subCategoryId}"
                               data-name="${escapeHtml(sc.subCategoryName || '')}">
                                <i class="bi bi-trash3 me-2"></i>Delete
                            </a>
                        </li>
                    </ul>
                </td>
            </tr>
        `;
        $tbody.append(rowHtml);
    });
}

// ─────────────────────────────────────────────────────────────
// SUBMIT — Insert ya Update decide karta hai hdnEditMode se
// ─────────────────────────────────────────────────────────────
function onSubmitSubCategoryClick() {
    if ($('#hdnEditMode').val() === 'true') {
        doUpdateSubCategory();
    } else {
        doInsertSubCategory();
    }
}

function onCancelEditClick() {
    enterInsertMode();
}

// ─────────────────────────────────────────────────────────────
// INSERT SUBCATEGORY
// POST: /ABC/ABCMaster/InsertSubCategory
// Web Model: ABCSubCategoryInsertModel
// { subCategoryName, subCategoryCode, categoryCode }
// createdBy & createdIPAddress — Web Controller session se set karta hai
// ─────────────────────────────────────────────────────────────
function doInsertSubCategory() {
    const subCategoryName = $('#txtSubCategory').val().trim();

    if (!subCategoryName) {
        showError('Please enter subcategory name');
        $('#txtSubCategory').focus();
        return;
    }

    if (!selectedCategoryCode) {
        showError('Missing category information. Please go back and select again.');
        return;
    }

    const insertData = {
        subCategoryName: subCategoryName,
        subCategoryCode: null,              // SP auto-generate karta hai
        categoryCode:    selectedCategoryCode
        // createdBy & createdIPAddress: Web Controller session se set karega
    };

    $('#btnSubmitSubCategory').prop('disabled', true).text('Saving...');

    $.ajax({
        url: '/ABC/ABCMaster/InsertSubCategory',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(insertData),
        dataType: 'json',
        success: function (response) {
            if (response && response.isSessionTimeout) {
                window.location.href = response.returnUrlAfterLogout;
                return;
            }
            if (response && response.isSucceeded) {
                showSuccess('SubCategory added successfully!');
                $('#txtSubCategory').val('');
                loadSubCategoryList();
            } else {
                showError(response.errorMessage || 'Failed to add subcategory');
            }
        },
        error: function (xhr) {
            try {
                const err = JSON.parse(xhr.responseText);
                showError(err.error || err.message || 'Error occurred');
            } catch (e) {
                showError('Error adding subcategory');
            }
        },
        complete: function () {
            $('#btnSubmitSubCategory').prop('disabled', false).text('Submit');
        }
    });
}

// ─────────────────────────────────────────────────────────────
// UPDATE SUBCATEGORY
// POST: /ABC/ABCMaster/UpdateSubCategory
// Web Model: ABCSubCategoryUpdateModel
// { subCategoryId, subCategoryName, subCategoryCode, categoryCode }
// modifiedBy & modifiedIPAddress — Web Controller session se set karta hai
// ─────────────────────────────────────────────────────────────
function doUpdateSubCategory() {
    const subCategoryId   = parseInt($('#hdnEditSubCategoryId').val());
    const subCategoryName = $('#txtSubCategory').val().trim();
    const subCategoryCode = $('#hdnEditSubCategoryCode').val() || '';

    if (!subCategoryName) {
        showError('SubCategory name cannot be empty');
        $('#txtSubCategory').focus();
        return;
    }

    if (!subCategoryId || subCategoryId <= 0) {
        showError('Invalid SubCategory ID');
        return;
    }

    const updateData = {
        subCategoryId:   subCategoryId,
        subCategoryName: subCategoryName,
        subCategoryCode: subCategoryCode,
        categoryCode:    selectedCategoryCode
        // modifiedBy & modifiedIPAddress: Web Controller session se set karega
    };

    $('#btnSubmitSubCategory').prop('disabled', true).text('Updating...');

    $.ajax({
        url: '/ABC/ABCMaster/UpdateSubCategory',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(updateData),
        dataType: 'json',
        success: function (response) {
            if (response && response.isSessionTimeout) {
                window.location.href = response.returnUrlAfterLogout;
                return;
            }
            if (response && response.isSucceeded) {
                showSuccess('SubCategory updated successfully!');
                enterInsertMode();
                loadSubCategoryList();
            } else {
                showError(response.errorMessage || 'Failed to update subcategory');
                $('#btnSubmitSubCategory').prop('disabled', false).text('Update');
            }
        },
        error: function (xhr) {
            try {
                const err = JSON.parse(xhr.responseText);
                showError(err.error || err.errorMessage || 'Error occurred');
            } catch (e) {
                showError('Error updating subcategory');
            }
            $('#btnSubmitSubCategory').prop('disabled', false).text('Update');
        }
    });
}

// ─────────────────────────────────────────────────────────────
// EDIT button click — same top txtSubCategory textbox mein naam daalo
// ─────────────────────────────────────────────────────────────
function onEditSubCategoryClick() {
    const subCategoryId   = $(this).data('id');
    const subCategoryName = $(this).data('name');
    const subCategoryCode = $(this).data('code');
    enterEditMode(subCategoryId, subCategoryName, subCategoryCode);
}

// ─────────────────────────────────────────────────────────────
// DELETE — confirmation modal open karo
// ─────────────────────────────────────────────────────────────
function onDeleteSubCategoryClick() {
    const subCategoryId   = $(this).data('id');
    const subCategoryName = $(this).data('name');

    $('#deleteSubCategoryId').val(subCategoryId);
    $('#deleteSubCategoryNameDisplay').text(subCategoryName);
    new bootstrap.Modal(document.getElementById('deleteSubCategoryModal')).show();
}

// ─────────────────────────────────────────────────────────────
// CONFIRM DELETE
// POST: /ABC/ABCMaster/DeleteSubCategory
// Web Model: ABCSubCategoryDeleteModel
// { subCategoryId }
// deletedBy & deletedIPAddress — Web Controller session se set karta hai
// ─────────────────────────────────────────────────────────────
function onConfirmDeleteClick() {
    const subCategoryId = parseInt($('#deleteSubCategoryId').val());

    if (!subCategoryId || subCategoryId <= 0) {
        showError('Invalid SubCategory ID');
        return;
    }

    const deleteData = {
        subCategoryId: subCategoryId
        // deletedBy & deletedIPAddress: Web Controller session se set karega
    };

    $('#btnConfirmDeleteSubCategory').prop('disabled', true).text('Deleting...');

    $.ajax({
        url: '/ABC/ABCMaster/DeleteSubCategory',
        type: 'POST',   // ✅ POST — API [HttpPost] expect karta hai
        contentType: 'application/json',
        data: JSON.stringify(deleteData),
        dataType: 'json',
        success: function (response) {
            bootstrap.Modal.getInstance(document.getElementById('deleteSubCategoryModal')).hide();

            if (response && response.isSessionTimeout) {
                window.location.href = response.returnUrlAfterLogout;
                return;
            }
            if (response && response.isSucceeded) {
                // Agar deleted subcategory ka edit chal raha tha toh reset karo
                if ($('#hdnEditMode').val() === 'true' &&
                    parseInt($('#hdnEditSubCategoryId').val()) === subCategoryId) {
                    enterInsertMode();
                }
                showSuccess('SubCategory deleted successfully!');
                loadSubCategoryList();
            } else {
                showError(response.errorMessage || 'Failed to delete subcategory');
            }
        },
        error: function (xhr) {
            bootstrap.Modal.getInstance(document.getElementById('deleteSubCategoryModal')).hide();
            try {
                const err = JSON.parse(xhr.responseText);
                showError(err.error || err.errorMessage || 'Error occurred');
            } catch (e) {
                showError('Error deleting subcategory');
            }
        },
        complete: function () {
            $('#btnConfirmDeleteSubCategory').prop('disabled', false).text('Yes, Delete');
        }
    });
}

// ─────────────────────────────────────────────────────────────
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
