// ─────────────────────────────────────────────────────────────
// INSERT CATEGORY
// POST: /ABC/ABCMaster/InsertCategory
// Web Model: ABCCategoryInsertModel
// API Model: ABCCategoryInsertModel (same fields)
// CreatedBy & CreatedIPAddress — session se set hota hai
// ─────────────────────────────────────────────────────────────
[HttpPost]
public async Task<IActionResult> InsertCategory([FromBody] ABCCategoryInsertModel model)
{
    var responseObj = new ABCCategoryInsertResponseModel
    {
        isSucceeded          = false,
        isSessionTimeout     = false,
        returnUrlAfterLogout = "",
        errorMessage         = "",
        data                 = new ABCCategoryInsertResponseData()
    };

    if (_workflowSession?.LoggedInUser == null)
    {
        responseObj.returnUrlAfterLogout = Url.Content(CommonConstants.LOGINREDIRECT);
        responseObj.isSessionTimeout     = true;
        return Json(responseObj);
    }

    try
    {
        if (model == null)
        {
            responseObj.errorMessage = "Request body cannot be null";
            return Json(responseObj);
        }

        if (string.IsNullOrWhiteSpace(model.CategoryName))
        {
            responseObj.errorMessage = "Category name is required";
            return Json(responseObj);
        }

        // Session se set karo
        model.CreatedBy        = _workflowSession.LoggedInUser.EmployeeCode;
        model.CreatedIPAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        _logger.LogInformation($"Calling API InsertCategory: {HelperLayer.Constants.APIConstants.ABCAPIConstants.InsertCategory}");

        var httpClient  = APIHelper.GetHttpClient(_workflowSession.LoggedInUser, _settings.APIUrl);
        var apiResponse = await httpClient.PostAsJsonAsync(
            HelperLayer.Constants.APIConstants.ABCAPIConstants.InsertCategory,
            model
        );

        if (apiResponse.IsSuccessStatusCode)
        {
            var result  = await apiResponse.Content.ReadAsStringAsync();
            var apiData = JsonConvert.DeserializeObject<ABCCategoryInsertResponseData>(result);

            if (apiData != null)
            {
                responseObj.isSucceeded  = apiData.Status == 1;
                responseObj.data         = apiData;
                responseObj.errorMessage = apiData.Message;
            }
            else
            {
                responseObj.errorMessage = "Failed to insert category";
            }
        }
        else
        {
            var errorContent     = await apiResponse.Content.ReadAsStringAsync();
            responseObj.errorMessage = $"API Error: {apiResponse.StatusCode} - {errorContent}";
            _logger.LogError($"InsertCategory API Error: {apiResponse.StatusCode} - {errorContent}");
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "InsertCategory Exception");
        responseObj.errorMessage = ex.Message;
    }

    return Json(responseObj);
}

// ─────────────────────────────────────────────────────────────
// UPDATE CATEGORY
// POST: /ABC/ABCMaster/UpdateCategory
// Web Model: ABCCategoryUpdateModel
// API Model: ABCCategoryUpdateModel (same fields)
// ModifiedBy & ModifiedIPAddress — session se set hota hai
// ─────────────────────────────────────────────────────────────
[HttpPost]
public async Task<IActionResult> UpdateCategory([FromBody] ABCCategoryUpdateModel model)
{
    var responseObj = new ABCCategoryUpdateResponseModel
    {
        isSucceeded          = false,
        isSessionTimeout     = false,
        returnUrlAfterLogout = "",
        errorMessage         = "",
        data                 = new ABCCategoryInsertResponseData()
    };

    if (_workflowSession?.LoggedInUser == null)
    {
        responseObj.returnUrlAfterLogout = Url.Content(CommonConstants.LOGINREDIRECT);
        responseObj.isSessionTimeout     = true;
        return Json(responseObj);
    }

    try
    {
        if (model == null || model.CategoryId <= 0)
        {
            responseObj.errorMessage = "Valid Category ID is required";
            return Json(responseObj);
        }

        if (string.IsNullOrWhiteSpace(model.CategoryName))
        {
            responseObj.errorMessage = "Category name is required";
            return Json(responseObj);
        }

        // Session se set karo
        model.ModifiedBy        = _workflowSession.LoggedInUser.EmployeeCode;
        model.ModifiedIPAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        _logger.LogInformation($"Calling API UpdateCategory for CategoryId: {model.CategoryId}");

        var httpClient  = APIHelper.GetHttpClient(_workflowSession.LoggedInUser, _settings.APIUrl);
        var apiResponse = await httpClient.PostAsJsonAsync(   // ✅ POST — API [HttpPost] expect karta hai
            HelperLayer.Constants.APIConstants.ABCAPIConstants.UpdateCategory,
            model
        );

        if (apiResponse.IsSuccessStatusCode)
        {
            var result  = await apiResponse.Content.ReadAsStringAsync();
            var apiData = JsonConvert.DeserializeObject<ABCCategoryInsertResponseData>(result);

            if (apiData != null)
            {
                responseObj.isSucceeded  = apiData.Status == 1;
                responseObj.data         = apiData;
                responseObj.errorMessage = apiData.Message;
            }
            else
            {
                responseObj.errorMessage = "Failed to update category";
            }
        }
        else
        {
            var errorContent         = await apiResponse.Content.ReadAsStringAsync();
            responseObj.errorMessage = $"API Error: {apiResponse.StatusCode} - {errorContent}";
            _logger.LogError($"UpdateCategory API Error: {apiResponse.StatusCode} - {errorContent}");
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "UpdateCategory Exception");
        responseObj.errorMessage = ex.Message;
    }

    return Json(responseObj);
}

// ─────────────────────────────────────────────────────────────
// DELETE CATEGORY
// POST: /ABC/ABCMaster/DeleteCategory
// Web Model: ABCCategoryDeleteModel
// API Model: ABCCategoryDeleteModel (same fields)
// DeletedBy & DeletedIPAddress — session se set hota hai
// ─────────────────────────────────────────────────────────────
[HttpPost]
public async Task<IActionResult> DeleteCategory([FromBody] ABCCategoryDeleteModel model)
{
    var responseObj = new ABCCategoryDeleteResponseModel
    {
        isSucceeded          = false,
        isSessionTimeout     = false,
        returnUrlAfterLogout = "",
        errorMessage         = "",
        data                 = new ABCCategoryInsertResponseData()
    };

    if (_workflowSession?.LoggedInUser == null)
    {
        responseObj.returnUrlAfterLogout = Url.Content(CommonConstants.LOGINREDIRECT);
        responseObj.isSessionTimeout     = true;
        return Json(responseObj);
    }

    try
    {
        if (model == null || model.CategoryId <= 0)
        {
            responseObj.errorMessage = "Valid Category ID is required";
            return Json(responseObj);
        }

        // Session se set karo
        model.DeletedBy        = _workflowSession.LoggedInUser.EmployeeCode;
        model.DeletedIPAddress = HttpContext.Connection.RemoteIpAddress?.ToString() ?? "Unknown";

        _logger.LogInformation($"Calling API DeleteCategory for CategoryId: {model.CategoryId}");

        var httpClient  = APIHelper.GetHttpClient(_workflowSession.LoggedInUser, _settings.APIUrl);
        var apiResponse = await httpClient.PostAsJsonAsync(   // ✅ POST — HttpMethod.Delete nahi
            HelperLayer.Constants.APIConstants.ABCAPIConstants.DeleteCategory,
            model
        );

        if (apiResponse.IsSuccessStatusCode)
        {
            var result  = await apiResponse.Content.ReadAsStringAsync();
            var apiData = JsonConvert.DeserializeObject<ABCCategoryInsertResponseData>(result);

            if (apiData != null)
            {
                responseObj.isSucceeded  = apiData.Status == 1;
                responseObj.data         = apiData;
                responseObj.errorMessage = apiData.Message;
            }
            else
            {
                responseObj.errorMessage = "Failed to delete category";
            }
        }
        else
        {
            var errorContent         = await apiResponse.Content.ReadAsStringAsync();
            responseObj.errorMessage = $"API Error: {apiResponse.StatusCode} - {errorContent}";
            _logger.LogError($"DeleteCategory API Error: {apiResponse.StatusCode} - {errorContent}");
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "DeleteCategory Exception");
        responseObj.errorMessage = ex.Message;
    }

    return Json(responseObj);
}
